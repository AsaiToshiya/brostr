<!DOCTYPE html>
<html style="height: 100%; margin: 0; padding: 0; width: 100%">
  <head>
    <title>Brostr</title>
  </head>
  <body
    style="
      display: flex;
      flex-direction: column;
      height: 100%;
      margin: 0;
      padding: 0;
      width: 100%;
    "
  >
    <div>
      <input
        id="nip19"
        type="text"
        size="50"
        value="nevent1qqsd2svzwvnmtrquga3a08tntr7lp6w4me755z8ym284jtm7xf9wf9gc8ywjf"
      />
      <button onclick="handleClick()">Go</button>
    </div>
    <iframe id="iframe" style="flex-grow: 1; margin: 0; padding: 0"></iframe>

    <script src="https://unpkg.com/nostr-tools/lib/nostr.bundle.js"></script>
    <script>
      const RELAYS = [
        "wss://nos.lol",
        "wss://nostr-pub.wellorder.net",
        "wss://nostr.bitcoiner.social",
        "wss://nostr.mom",
        "wss://nostr.oxtr.dev",
        "wss://relay-jp.nostr.wirednet.jp",
        "wss://relay.damus.io",
        "wss://relay.nostr.bg",
      ];

      const convertNip19ToDataUrl = (
        tagName,
        attributeName,
        mimeType,
        events
      ) => {
        [
          ...iframe.contentWindow.document.querySelectorAll(
            `${tagName}[${attributeName}^='nostr:']`
          ),
        ].map((el) => {
          const nip19 = el[attributeName];

          const event = events[nip19];

          el[attributeName] =
            `data:${mimeType};base64,` +
            btoa(unescape(encodeURIComponent(event.content)));
        });
      };

      // { [nip21: `nostr:${string}`]: Event<number> }[] を返す
      const fetchResourceEvents = async () => {
        const nip21s = [
          ...[
            ...iframe.contentWindow.document.querySelectorAll(
              "script[src^='nostr:']"
            ),
          ].map((script) => script.src),
          ...[
            ...iframe.contentWindow.document.querySelectorAll(
              "link[href^='nostr:']"
            ),
          ].map((link) => link.href),
          ...[
            ...iframe.contentWindow.document.querySelectorAll(
              "img[src^='nostr:']"
            ),
          ].map((img) => img.src),
        ];

        const pool = new window.NostrTools.SimplePool();
        const ids = nip21s.map((nip19) => {
          const { id } = window.NostrTools.nip19.decode(
            nip19.replace(/^nostr:/, "")
          ).data;
          return id;
        });
        const events = await pool.list(RELAYS, [
          {
            ids,
          },
        ]);
        await pool.close(RELAYS);

        return nip21s.reduce((acc, obj) => {
          const { id } = window.NostrTools.nip19.decode(
            obj.replace(/^nostr:/, "")
          ).data;
          return { ...acc, [obj]: events.find((event) => event.id == id) };
        }, {});
      };

      const onload = async () => {
        iframe.contentWindow.document.querySelectorAll("a").forEach((a) => {
          a.href = a.href.replace(/^nostr:/, "");
        });

        const events = await fetchResourceEvents();

        convertNip19ToDataUrl("script", "src", "text/javascript", events);

        convertNip19ToDataUrl("link", "href", "text/css", events);

        [
          ...iframe.contentWindow.document.querySelectorAll(
            "img[src^='nostr:']"
          ),
        ].map((img) => {
          const nip19 = img.src;

          const event = events[nip19];

          const typeTag = event.tags.find((tag) => tag[0] == "type");
          typeTag && (img.src = `data:${typeTag[1]};base64,${event.content}`);
        });

        iframe.srcdoc = new XMLSerializer().serializeToString(
          iframe.contentWindow.document
        );
        iframe.onload = () => {
          iframe.onload = () => {
            const path = iframe.contentWindow.location.pathname;
            (async () => await updateContent(path.substring(1)))();
          };
        };
      };

      const updateContent = async (nip19) => {
        const { id } = window.NostrTools.nip19.decode(
          nip19.replace(/^nostr:/, "")
        ).data;
        const pool = new window.NostrTools.SimplePool();
        const event = await pool.get(RELAYS, {
          ids: [id],
        });
        iframe.srcdoc =
          event.kind == 5392
            ? event.content
            : `<pre>${JSON.stringify(event, null, 2)}</pre>`;
        iframe.onload = onload;
      };

      const handleClick = async () => await updateContent(nip19.value);
    </script>
  </body>
</html>
